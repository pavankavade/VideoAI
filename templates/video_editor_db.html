<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Video Editor - Manga AI</title>
  <link rel="icon" href="/static/blur_glitch_background.png" />
  <link rel="stylesheet" href="/static/video_editor.css" />
  <script src="/static/vendor/ffmpeg/ffmpeg.min.js"></script>
</head>
<body>
  <div style="padding:12px 20px; display:flex; justify-content:space-between; align-items:center; background:linear-gradient(90deg,#071226,#08162a);">
    <div style="color:#dff3ff; font-weight:700; font-size:18px;">Video Editor - {{ project.title or 'Untitled' }}</div>
    <div style="display:flex; gap:8px;">
      <button class="btn" id="canvasRenderBtn">ðŸŽ¬ Render with Canvas</button>
      <button class="btn" id="clientRenderBtn">âš¡ Render with FFmpeg</button>
    </div>
  </div>
  <div class="editor-root">
    <div class="left-assets">
      <!-- Split into two equal sections that scroll if content overflows -->
      <div class="asset-section">
        <div class="section-title">Panels</div>
        <div id="panelsList" class="assets-list"></div>
      </div>

      <div class="asset-section">
        <div class="section-title">Audio</div>
        <div id="audioList" class="assets-list"></div>
        <div style="margin-top:8px;">
          <input id="audioFileInput" type="file" accept="audio/*" />
        </div>
      </div>
    </div>

    <div class="player-area">
      <div class="player-top">
        <div class="preview-player" id="previewPlayer">
          <div class="canvas-wrap">
            <canvas id="editorCanvas"></canvas>
            <div class="preview-overlay" id="previewOverlay">
              <div class="preview-toolbar">
                <button class="btn small" id="togglePlay">Play</button>
                <button class="btn small secondary" id="toggleCrop">Crop: Off</button>
                <div class="time-readout" id="timeReadout">0:00</div>
                <input type="range" id="seekSlider" min="0" max="1" value="0" step="0.001" style="width:260px"/>
                <div class="time-readout" id="totalTimeReadout">/ 0:00</div>
              </div>
            </div>
          </div>
        </div>
        <div class="inspector">
          <h4>Inspector</h4>
          <div id="inspector">Select a clip on the timeline to edit its duration/offset.</div>
        </div>
      </div>

      <div class="timeline" id="timelineRoot">
        <div class="timeline-header">
          <div style="font-weight:600">Timeline</div>
          <div class="controls">
            <button class="btn secondary" id="clearTimeline">Clear</button>
            <button class="btn primary" id="generatePanelTimeline">ðŸŽ¬ Generate Panel Timeline</button>
            <button class="btn" id="playTimeline">Play</button>
          </div>
          <div id="timelineControlsExtra" style="display:flex;gap:8px;align-items:center;margin-left:12px">
            <div class="timeline-scale-note">Zoom</div>
            <button class="btn" id="zoomOut">-</button>
            <button class="btn" id="zoomIn">+</button>
            <label style="color:#9fd2ff">Snap
              <select id="snapSelect" style="margin-left:6px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:#dff3ff;padding:6px;border-radius:6px">
                <option value="0.033333">Frame (1/30s)</option>
                <option value="0.0333333">Frame (1/30s) (alt)</option>
                <option value="0.1" selected>0.1s</option>
                <option value="0.5">0.5s</option>
                <option value="1">1s</option>
              </select>
            </label>
            <label style="color:#9fd2ff;display:flex;align-items:center;gap:6px"><input type="checkbox" id="reflowToggle" checked/>Reflow</label>
            <div style="width:1px;height:20px;background:rgba(255,255,255,0.1);margin:0 4px;"></div>
            <label style="display:flex;align-items:center;gap:8px;color:#9fd2ff;font-size:12px;">
              <span style="font-weight:600;">Panel Size:</span>
              <input type="range" id="panelSizeSlider" min="0.1" max="1.5" value="0.5" step="0.05" style="width:120px;accent-color:#3b82f6;cursor:pointer;"/>
              <span id="panelSizeValue" style="min-width:40px;font-weight:700;color:#60a5fa;">50%</span>
              <button class="btn secondary" id="resetPanelSize" style="padding:4px 8px;font-size:11px;">Reset</button>
            </label>
            <div style="width:1px;height:20px;background:rgba(255,255,255,0.1);margin:0 4px;"></div>
            <label style="display:flex;align-items:center;gap:8px;color:#9fd2ff;font-size:12px;">
              <span style="font-weight:600;">Anim Speed:</span>
              <input type="range" id="animSpeedSlider" min="0.1" max="3.0" value="1.0" step="0.1" style="width:120px;accent-color:#3b82f6;cursor:pointer;"/>
              <span id="animSpeedValue" style="min-width:40px;font-weight:700;color:#60a5fa;">1.0x</span>
              <button class="btn secondary" id="resetAnimSpeed" style="padding:4px 8px;font-size:11px;">Reset</button>
            </label>
            <div style="width:1px;height:20px;background:rgba(255,255,255,0.1);margin:0 4px;"></div>
            <button class="btn secondary" id="saveNow">Save</button>
            <button class="btn secondary" id="testSave" onclick="testSaveFunction()" style="background: #dc3545;">Test Save</button>
            <div id="autosaveStatus" style="font-size:12px;color:#9fbfdc">Idle</div>
          </div>
        </div>
        <div class="timeline-viewport">
          <div class="timeline-ruler" id="timelineRuler"></div>
          <div class="timeline-track-outer" id="timelineOuter">
            <div class="timeline-track" id="timelineTrack" ondragover="event.preventDefault()" ondrop="onDropToTimeline(event)"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="application/json" id="__project_data__">{{ project|tojson|safe }}</script>
  <script>
    try { const el = document.getElementById('__project_data__'); window.projectData = JSON.parse(el.textContent || '{}'); } catch(e){ window.projectData = {}; }
  </script>
  <!-- Load the DB-specific editor (standalone, no legacy dependency) -->
  <script src="/static/video_editor_db_core.js"></script>
  <script>
    // Simple optional progress UI; video_editor.js will set window.__renderJobId
    (function(){
      const bar = document.createElement('div');
      bar.id = 'renderProgressBar';
      bar.style.position='fixed'; bar.style.left='20px'; bar.style.bottom='20px'; bar.style.minWidth='320px';
      bar.style.padding='10px 12px'; bar.style.borderRadius='8px'; bar.style.background='rgba(7,18,38,0.9)'; bar.style.color='#dff3ff'; bar.style.fontSize='12px';
      bar.style.boxShadow='0 6px 22px rgba(0,0,0,0.35)'; bar.style.backdropFilter='blur(6px)'; bar.style.display='none';
      bar.innerHTML = '<div style="font-weight:700;margin-bottom:6px">Render Progress</div><div id="rpStage">â€”</div><div id="rpDetail" style="opacity:0.8"></div>';
      document.body.appendChild(bar);
      function connect(jobId){
        if (!jobId) return;
        bar.style.display='block';
  const base = (window.__RENDER_API__ && window.__RENDER_API__.progressBase) || '/api/progress/stream/';
  const es = new EventSource(base + encodeURIComponent(jobId));
        const stEl = bar.querySelector('#rpStage');
        const dtEl = bar.querySelector('#rpDetail');
        
        // Auto-close connection after 30 seconds to prevent infinite loading
        const autoCloseTimeout = setTimeout(() => {
          try { es.close(); } catch(_) {}
          bar.style.display = 'none';
        }, 30000);
        
        es.addEventListener('progress', (ev)=>{
          try{
            const d = JSON.parse(ev.data||'{}');
            if (stEl) stEl.textContent = (d.stage||'') + ' â€“ ' + (d.status||'');
            if (dtEl) dtEl.textContent = (d.url ? ('URL: ' + d.url) : '') + (d.detail? (' ' + d.detail) : '');
            if (d.stage === 'finalize' && (d.status==='complete' || d.status==='link_error')){
              clearTimeout(autoCloseTimeout);
              setTimeout(()=>{ bar.style.display='none'; try{ es.close(); }catch(_){} }, 1200);
            }
          }catch(e){}
        });
        
        es.addEventListener('open', () => {
          console.log('Progress stream connected');
        });
        
        es.onerror = (e) => {
          console.warn('Progress stream error:', e);
          clearTimeout(autoCloseTimeout);
          try { es.close(); } catch(_e) {}
          setTimeout(() => { bar.style.display = 'none'; }, 1000);
        };
      }
      Object.defineProperty(window, '__renderJobId', { set: (v)=>{ try{ connect(v); }catch(_){}; } });
    })();
  </script>
  
  <!-- Loading Modal -->
  <div id="loadingModal" class="loading-modal" style="display: none;">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-title">Loading Video Editor</div>
      <div class="loading-status" id="loadingStatus">Initializing...</div>
      <div class="loading-progress">
        <div class="progress-bar">
          <div class="progress-fill" id="loadingProgress"></div>
        </div>
        <div class="progress-text" id="loadingProgressText">0%</div>
      </div>
    </div>
  </div>
</body>
</html>
