<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Video Editor - Manga AI</title>
  <link rel="icon" href="/static/blur_glitch_background.png" />
  <link rel="stylesheet" href="/static/video_editor.css" />
</head>
<body>
  <div style="padding:12px 20px; display:flex; justify-content:space-between; align-items:center; background:linear-gradient(90deg,#071226,#08162a);">
    <div style="color:#dff3ff; font-weight:700; font-size:18px;">Video Editor - {{ project.title or 'Untitled' }}</div>
    <div style="display:flex; gap:8px;">
      <button class="btn" id="renderBtn" style="background: linear-gradient(135deg, #10b981, #059669); font-weight: 600;" title="Render video with audio">üé¨ Render</button>
    </div>
  </div>
  <div class="editor-root">
    <div class="left-assets">
      <!-- Split into two equal sections that scroll if content overflows -->
      <div class="asset-section">
        <div class="section-title">Panels</div>
        <div id="panelsList" class="assets-list"></div>
      </div>

      <div class="asset-section">
        <div class="section-title">Audio</div>
        <div id="audioList" class="assets-list"></div>
        <div style="margin-top:8px;">
          <input id="audioFileInput" type="file" accept="audio/*" />
        </div>
      </div>
    </div>

    <div class="player-area">
      <div class="player-top">
        <div class="preview-player" id="previewPlayer">
          <div class="canvas-wrap">
            <canvas id="editorCanvas"></canvas>
            <div class="preview-overlay" id="previewOverlay">
              <div class="preview-toolbar">
                <button class="btn small" id="togglePlay">Play</button>
                <button class="btn small secondary" id="toggleCrop">Crop: Off</button>
                <div class="time-readout" id="timeReadout">0:00</div>
                <input type="range" id="seekSlider" min="0" max="1" value="0" step="0.001" style="width:260px"/>
                <div class="time-readout" id="totalTimeReadout">/ 0:00</div>
              </div>
            </div>
          </div>
        </div>
        <div class="inspector">
          <h4>Inspector</h4>
          <div id="inspector">Select a clip on the timeline to edit its duration/offset.</div>
        </div>
      </div>

      <div class="timeline" id="timelineRoot">
        <div class="timeline-header">
          <div style="font-weight:600">Timeline</div>
          <div class="controls">
            <button class="btn secondary" id="clearTimeline">Clear</button>
            <button class="btn primary" id="generatePanelTimeline">üé¨ Generate Panel Timeline</button>
            <button class="btn" id="playTimeline">Play</button>
          </div>
          <div id="timelineControlsExtra" style="display:flex;gap:8px;align-items:center;margin-left:12px">
            <div class="timeline-scale-note">Zoom</div>
            <button class="btn" id="zoomOut">-</button>
            <button class="btn" id="zoomIn">+</button>
            <label style="color:#9fd2ff">Snap
              <select id="snapSelect" style="margin-left:6px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:#dff3ff;padding:6px;border-radius:6px">
                <option value="0.033333">Frame (1/30s)</option>
                <option value="0.0333333">Frame (1/30s) (alt)</option>
                <option value="0.1" selected>0.1s</option>
                <option value="0.5">0.5s</option>
                <option value="1">1s</option>
              </select>
            </label>
            <label style="color:#9fd2ff;display:flex;align-items:center;gap:6px"><input type="checkbox" id="reflowToggle" checked/>Reflow</label>
            <div style="width:1px;height:20px;background:rgba(255,255,255,0.1);margin:0 4px;"></div>
            <label style="display:flex;align-items:center;gap:8px;color:#9fd2ff;font-size:12px;">
              <span style="font-weight:600;">Panel Size:</span>
              <input type="range" id="panelSizeSlider" min="0.1" max="1.5" value="0.5" step="0.05" style="width:120px;accent-color:#3b82f6;cursor:pointer;"/>
              <span id="panelSizeValue" style="min-width:40px;font-weight:700;color:#60a5fa;">50%</span>
              <button class="btn secondary" id="resetPanelSize" style="padding:4px 8px;font-size:11px;">Reset</button>
            </label>
            <div style="width:1px;height:20px;background:rgba(255,255,255,0.1);margin:0 4px;"></div>
            <label style="display:flex;align-items:center;gap:8px;color:#9fd2ff;font-size:12px;">
              <span style="font-weight:600;">Anim Speed:</span>
              <input type="range" id="animSpeedSlider" min="0.1" max="3.0" value="1.0" step="0.1" style="width:120px;accent-color:#3b82f6;cursor:pointer;"/>
              <span id="animSpeedValue" style="min-width:40px;font-weight:700;color:#60a5fa;">1.0x</span>
              <button class="btn secondary" id="resetAnimSpeed" style="padding:4px 8px;font-size:11px;">Reset</button>
            </label>
            <div style="width:1px;height:20px;background:rgba(255,255,255,0.1);margin:0 4px;"></div>
            <button class="btn secondary" id="saveNow">Save</button>
            <button class="btn secondary" id="testSave" onclick="testSaveFunction()" style="background: #dc3545;">Test Save</button>
            <div id="autosaveStatus" style="font-size:12px;color:#9fbfdc">Idle</div>
          </div>
        </div>
        <div class="timeline-viewport">
          <div class="timeline-ruler" id="timelineRuler"></div>
          <div class="timeline-track-outer" id="timelineOuter">
            <div class="timeline-track" id="timelineTrack" ondragover="event.preventDefault()" ondrop="onDropToTimeline(event)"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="application/json" id="__project_data__">{{ project|tojson|safe }}</script>
  <script>
    try { const el = document.getElementById('__project_data__'); window.projectData = JSON.parse(el.textContent || '{}'); } catch(e){ window.projectData = {}; }
  </script>
  <!-- Load the DB-specific editor (standalone, no legacy dependency) -->
  <script src="/static/video_editor_db_core.js"></script>
  <script>
    // Enhanced progress UI with time tracking
    (function(){
      const bar = document.createElement('div');
      bar.id = 'renderProgressBar';
      bar.style.cssText = `
        position: fixed; left: 20px; bottom: 20px; min-width: 380px; max-width: 450px;
        padding: 16px 18px; border-radius: 12px; background: rgba(7,18,38,0.95); color: #dff3ff; 
        font-size: 13px; box-shadow: 0 8px 30px rgba(0,0,0,0.4); backdrop-filter: blur(10px); 
        display: none; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        border: 1px solid rgba(59, 130, 246, 0.3);
      `;
      bar.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
          <div style="font-weight: 700; font-size: 14px; color: #60a5fa;">üé¨ Render Progress</div>
          <button id="rpClose" style="display: none; background: rgba(255,255,255,0.1); border: none; color: white; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 11px;" onclick="this.parentElement.parentElement.style.display='none'">Close</button>
        </div>
        <div id="rpStage" style="font-weight: 600; margin-bottom: 4px;">‚Äî</div>
        <div id="rpDetail" style="opacity: 0.85; margin-bottom: 8px; font-size: 12px;"></div>
        <div id="rpTime" style="opacity: 0.75; font-size: 11px; margin-bottom: 8px;"></div>
        <div style="background: rgba(255,255,255,0.1); border-radius: 6px; height: 6px; overflow: hidden; margin-bottom: 6px;">
          <div id="rpProgress" style="background: linear-gradient(90deg, #3b82f6, #60a5fa); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
        </div>
        <div id="rpPercent" style="text-align: right; font-size: 11px; opacity: 0.7;">0%</div>
      `;
      document.body.appendChild(bar);
      
      function formatTime(seconds) {
        if (seconds == null || seconds < 0) return '‚Äî';
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
      }
      
      function connect(jobId){
        if (!jobId) {
          console.warn('[Progress Bar] No job ID provided');
          return;
        }
        
        console.log('[Progress Bar] Connecting to SSE stream for job:', jobId);
        bar.style.display='block';
        
        const url = '/editor/api/video/progress/stream/' + encodeURIComponent(jobId);
        console.log('[Progress Bar] SSE URL:', url);
        const es = new EventSource(url);
        const stEl = bar.querySelector('#rpStage');
        const dtEl = bar.querySelector('#rpDetail');
        const tmEl = bar.querySelector('#rpTime');
        const pgEl = bar.querySelector('#rpProgress');
        const pcEl = bar.querySelector('#rpPercent');
        
        let downloadStarted = false;
        
        es.onopen = () => {
          console.log('[Progress Bar] SSE connection opened successfully');
        };
        
        es.onmessage = (ev) => {
          try {
            const d = JSON.parse(ev.data || '{}');
            console.log('[Progress]', d);
            
            // Update stage
            if (d.stage && stEl) {
              const stageNames = {
                'initializing': 'üöÄ Initializing',
                'browser_ready': 'üåê Browser Ready',
                'loading_page': 'üìÑ Loading Editor',
                'assets_loading': 'üé® Loading Assets',
                'duration_detected': '‚è±Ô∏è Duration Detected',
                'setup_recording': 'üé• Setting Up Recorder',
                'recording_ready': '‚ñ∂Ô∏è Ready to Record',
                'recording': 'üî¥ Recording',
                'processing': '‚öôÔ∏è Processing',
                'downloading': 'üíæ Saving',
                'fixing_metadata': 'üîß Fixing Metadata',
                'complete': '‚úÖ Complete',
                'error': '‚ùå Error'
              };
              stEl.textContent = stageNames[d.stage] || d.stage;
            }
            
            // Update detail
            if (dtEl) dtEl.textContent = d.detail || '';
            
            // Update time tracking
            if (tmEl && (d.elapsed != null || d.remaining != null)) {
              const elapsed = d.elapsed_formatted || formatTime(d.elapsed);
              const remaining = d.remaining_formatted || formatTime(d.remaining);
              tmEl.innerHTML = `‚è±Ô∏è Elapsed: <strong>${elapsed}</strong> | Remaining: <strong>${remaining}</strong>`;
            }
            
            // Update progress bar
            if (d.progress != null && pgEl && pcEl) {
              const pct = Math.min(100, Math.max(0, d.progress));
              pgEl.style.width = pct + '%';
              pcEl.textContent = pct + '%';
            }
            
            // Handle completion - auto download and cleanup
            // Note: We may receive multiple 'complete' events - only process the one with download_url
            if (d.stage === 'complete' && d.download_url && !downloadStarted) {
              downloadStarted = true;
              
              console.log('[Progress] Complete event with download_url received:', d);
              
              // Re-enable render button
              const renderBtn = document.getElementById('renderBtn');
              if (renderBtn) {
                renderBtn.disabled = false;
                renderBtn.style.opacity = '1';
                renderBtn.style.cursor = 'pointer';
                renderBtn.textContent = 'üé¨ Render';
              }
              
              if (d.download_url) {
                // Show downloading status
                if (dtEl) dtEl.textContent = '‚¨áÔ∏è Starting download...';
                
                // Auto-download the file
                console.log('[Render] Auto-downloading from:', d.download_url);
                console.log('[Render] Full download URL:', window.location.origin + d.download_url);
                
                // Create download link
                const a = document.createElement('a');
                a.href = d.download_url;
                a.download = `render-${jobId}.webm`;
                a.style.display = 'none';
                document.body.appendChild(a);
                
                // Monitor download completion
                let downloadComplete = false;
                
                // Trigger download
                console.log('[Render] Triggering download click...');
                a.click();
                console.log('[Render] Download click triggered');
                
                // Update UI after a short delay (download started)
                setTimeout(() => {
                  if (dtEl) dtEl.textContent = '‚úÖ Download started! Check your downloads folder.';
                  if (pgEl) pgEl.style.background = 'linear-gradient(90deg, #10b981, #059669)';
                  
                  // Show close button
                  const closeBtn = bar.querySelector('#rpClose');
                  if (closeBtn) {
                    closeBtn.style.display = 'block';
                    closeBtn.onclick = () => {
                      bar.style.transition = 'opacity 0.3s';
                      bar.style.opacity = '0';
                      setTimeout(() => {
                        bar.style.display = 'none';
                        bar.style.opacity = '1';
                        try { es.close(); } catch(_) {}
                      }, 300);
                    };
                  }
                  
                  document.body.removeChild(a);
                }, 1000);
              } else {
                console.warn('[Render] No download_url in complete event!');
                // No download URL, just show close button
                const closeBtn = bar.querySelector('#rpClose');
                if (closeBtn) closeBtn.style.display = 'block';
              }
            } else if (d.stage === 'complete' && !d.download_url) {
              // Received complete without download_url (from headless_recorder)
              // Just update UI, wait for the real complete event with download_url
              console.log('[Progress] Intermediate complete event (waiting for download_url)...');
              if (dtEl) dtEl.textContent = d.detail || 'Processing complete, preparing download...';
              if (pgEl && pcEl) {
                pgEl.style.width = '100%';
                pcEl.textContent = '100%';
              }
            }
            
            // Handle errors
            if (d.stage === 'error') {
              if (pgEl) pgEl.style.background = 'linear-gradient(90deg, #ef4444, #dc2626)';
              
              // Re-enable render button on error
              const renderBtn = document.getElementById('renderBtn');
              if (renderBtn) {
                renderBtn.disabled = false;
                renderBtn.style.opacity = '1';
                renderBtn.style.cursor = 'pointer';
                renderBtn.textContent = 'üé¨ Render';
              }
              
              // Show close button on error
              const closeBtn = bar.querySelector('#rpClose');
              if (closeBtn) closeBtn.style.display = 'block';
            }
          } catch(e) {
            console.error('[Progress] Parse error:', e);
          }
        };
        
        es.onerror = (e) => {
          console.warn('[Progress] Stream error:', e);
          try { es.close(); } catch(_) {}
          setTimeout(() => { bar.style.display = 'none'; }, 2000);
        };
      }
      
      Object.defineProperty(window, '__renderJobId', { 
        set: (v) => {
          console.log('[Progress Bar] Job ID set to:', v);
          try { 
            connect(v); 
          } catch(e) {
            console.error('[Progress Bar] Error connecting:', e);
          } 
        } 
      });
    })();
  </script>
  
  <!-- Loading Modal -->
  <div id="loadingModal" class="loading-modal" style="display: none;">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-title">Loading Video Editor</div>
      <div class="loading-status" id="loadingStatus">Initializing...</div>
      <div class="loading-progress">
        <div class="progress-bar">
          <div class="progress-fill" id="loadingProgress"></div>
        </div>
        <div class="progress-text" id="loadingProgressText">0%</div>
      </div>
    </div>
  </div>
</body>
</html>
